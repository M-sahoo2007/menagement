{% extends "base.html" %}

{% block title %}Manage Students - Admin{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-users"></i> Manage Students</h2>
        </div>
    </div>

    <!-- Register New Student Form -->
    <div class="card shadow mb-5">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user-plus"></i> Register New Student</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_students') }}">
                <input type="hidden" name="action" value="register">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="roll_number" class="form-label">Roll Number *</label>
                        <input type="text" class="form-control" id="roll_number" name="roll_number" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="password" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="department" class="form-label">Department</label>
                        <input type="text" class="form-control" id="department" name="department">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-user-plus"></i> Register Student
                </button>
            </form>
        </div>
    </div>

    <!-- Students List -->
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> Registered Students ({{ students|length }})</h5>
            <button type="button" class="btn btn-sm btn-light" id="togglePasswordBtn">
                <i class="fas fa-eye-slash"></i> <span id="toggleText">Show Passwords</span>
            </button>
        </div>
        <div class="card-body">
            {% if students %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>No</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Roll Number</th>
                                <th>Password</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Joined</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr>
                                    <td>
                                        <!-- Display student_number (sequential, renumbered on delete) -->
                                        <span class="badge bg-secondary">{{ student['student_number'] }}</span>
                                    </td>
                                    <td>
                                        <i class="fas fa-user-circle"></i> {{ student['name'] }}
                                    </td>
                                    <td>{{ student['email'] }}</td>
                                    <td><span class="badge bg-info">{{ student['roll_number'] }}</span></td>
                                    <td>
                                        <code class="password-display" style="display:none; white-space:nowrap;" title="Student Password Hash">
                                            <small class="text-monospace" id="pwd-{{ student['id'] }}">{{ student['password'] }}</small>
                                        </code>
                                        <span class="password-hidden">
                                            <i class="fas fa-lock text-warning"></i> <small class="text-muted">Hidden</small>
                                        </span>
                                        <div class="mt-1">
                                                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" data-student-id="{{ student['id'] }}" data-action="show">
                                                                                <i class="fas fa-eye"></i> Show
                                                                            </button>
                                                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-student-id="{{ student['id'] }}" data-action="copy">
                                                                                <i class="fas fa-copy"></i> Copy
                                                                            </button>
                                        </div>
                                    </td>
                                    <td>{{ student['department'] or 'N/A' }}</td>
                                    <td>{{ student['phone'] or 'N/A' }}</td>
                                    <td><small class="text-muted">{{ student['created_at'][:10] }}</small></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-secondary me-1" 
                                            data-student-id="{{ student['id'] }}" data-student-name="{{ student['name']|e }}" data-action="reset">
                                                <i class="fas fa-key"></i> Reset
                                            </button>

                                            <form method="POST" action="{{ url_for('admin_students') }}" style="display:inline;">
                                                <input type="hidden" name="action" value="delete">
                                                <input type="hidden" name="student_id" value="{{ student['id'] }}">
                                                <button type="submit" class="btn btn-sm btn-danger confirm-submit" data-confirm="Are you sure you want to delete this student?">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info text-center py-4">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <p>No students registered yet.</p>
                    <p>Use the form above to register your first student.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-5">
        <div class="col-md-4 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary">{{ students|length }}</h3>
                    <p class="text-muted">Total Students</p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_students') }}" id="resetModalForm">
                <input type="hidden" name="action" value="reset_password">
                <input type="hidden" name="student_id" id="modal-student-id">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetModalLabel">Reset Student Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modal-student-name" class="fw-bold"></p>
                    <div class="mb-3">
                        <label for="modal-new-password" class="form-label">New Password</label>
                        <!-- show as text so admin can see the generated password; it's still sent securely to the server -->
                        <div class="input-group">
                            <input type="text" class="form-control" id="modal-new-password" name="new_password" required minlength="6" aria-label="New password">
                            <button type="button" class="btn btn-outline-secondary" data-modal-action="generate" title="Generate a secure password">
                                <i class="fas fa-random"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-modal-action="copy" title="Copy password to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">Admins can generate a secure temporary password here; the student will need to use it to login.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Set Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Admin Auth Modal (re-auth to reveal/copy) -->
<div class="modal fade" id="adminAuthModal" tabindex="-1" aria-labelledby="adminAuthModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminAuthModalLabel">Confirm Admin Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Enter your admin password to proceed with this sensitive action.</p>
                <div class="mb-2">
                    <input type="password" id="admin-auth-password" class="form-control" placeholder="Admin password">
                </div>
                <input type="hidden" id="admin-auth-action">
                <input type="hidden" id="admin-auth-target-type">
                <input type="hidden" id="admin-auth-target-id">
                <input type="hidden" id="admin-auth-details">
                <div id="admin-auth-feedback" class="text-danger small" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="admin-auth-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Show Plaintext After Reset Modal -->
<div class="modal fade" id="showPasswordModal" tabindex="-1" aria-labelledby="showPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="showPasswordModalLabel">Student Password Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="show-modal-student" class="fw-bold small text-truncate"></p>
                <div class="input-group mb-2">
                    <input type="text" id="show-modal-password" class="form-control text-monospace" readonly>
                    <button type="button" class="btn btn-outline-secondary" id="show-modal-copy" title="Copy password">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="small text-muted">This is the plaintext temporary password you just set. Share it with the student once; it won't be stored in plaintext.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

            <!-- Embedded last-reset JSON (server inject) -->
            <script id="last-reset-data" type="application/json">{{ last_reset|tojson | default('null') }}</script>

{% block scripts %}
<script>
let passwordsVisible = false;

function togglePasswordVisibility() {
    passwordsVisible = !passwordsVisible;
    
    const passwordDisplays = document.querySelectorAll('.password-display');
    const passwordHidden = document.querySelectorAll('.password-hidden');
    const toggleBtn = document.getElementById('togglePasswordBtn');
    const toggleText = document.getElementById('toggleText');
    
    if (passwordsVisible) {
        // Show passwords
        passwordDisplays.forEach(el => el.style.display = 'inline');
        passwordHidden.forEach(el => el.style.display = 'none');
        toggleBtn.classList.remove('btn-light');
        toggleBtn.classList.add('btn-warning');
        toggleText.innerHTML = '<i class="fas fa-eye"></i> Hide Passwords';
    } else {
        // Hide passwords
        passwordDisplays.forEach(el => el.style.display = 'none');
        passwordHidden.forEach(el => el.style.display = 'inline');
        toggleBtn.classList.remove('btn-warning');
        toggleBtn.classList.add('btn-light');
        toggleText.innerHTML = '<i class="fas fa-eye-slash"></i> Show Passwords';
    }
}

function openResetModal(id, name) {
    document.getElementById('modal-student-id').value = id;
    document.getElementById('modal-student-name').textContent = 'Student: ' + name;
    // Auto-generate a temporary password and prefill so admin can see/copy it
    try { generateModalPassword(); } catch (e) { /* ignore if not available */ }
    var resetModal = new bootstrap.Modal(document.getElementById('resetModal'));
    resetModal.show();
}

function openResetModalFromButton(btn) {
    var id = btn.getAttribute('data-student-id');
    var name = btn.getAttribute('data-student-name');
    openResetModal(id, name);
}

function toggleRowPassword(btn, skipAuth=false) {
    // Find the table row for this button
    const tr = btn.closest('tr');
    if (!tr) return;
    const pwdEl = tr.querySelector('.password-display');
    const hiddenEl = tr.querySelector('.password-hidden');
    const eyeIcon = btn.querySelector('i');

    if (!pwdEl || !hiddenEl) return;

    if (pwdEl.style.display === 'inline' || pwdEl.style.display === 'block') {
        // hide
        pwdEl.style.display = 'none';
        hiddenEl.style.display = 'inline';
        btn.innerHTML = '<i class="fas fa-eye"></i> Show';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-outline-primary');
    } else {
        // reveal without requiring re-auth
        pwdEl.style.display = 'inline';
        hiddenEl.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-danger');
        // Log reveal action to server for audit (non-blocking)
        try { sendAdminLog('reveal_password', 'student', btn.getAttribute('data-student-id'), 'Revealed password hash in admin UI (no re-auth)'); } catch(e){}
    }
}

function copyPassword(btn) {
    const studentId = btn.getAttribute('data-student-id');
    if (!studentId) return;
    const pwdEl = document.getElementById('pwd-' + studentId);
    if (!pwdEl) return;
    const text = pwdEl.textContent || pwdEl.innerText || '';
    // Copy directly without admin re-auth
    try {
        navigator.clipboard?.writeText(text).then(()=>{
            // optional visual feedback
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied';
            setTimeout(()=>{ btn.innerHTML = original; }, 1200);
        }).catch(()=>{});
    } catch(e) {}
    try { sendAdminLog('copy_password', 'student', studentId, 'Copied password hash from admin UI (no re-auth)'); } catch(e){}
}

// send audit log for admin UI events
function sendAdminLog(action, target_type, target_id, details) {
    try {
        fetch('/admin/log_action', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action, target_type: target_type, target_id: target_id, details: details })
        }).catch(()=>{});
    } catch(e) {}
}

// Generate a secure random password for the modal
function generatePassword(length = 12) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()_+-=[]{}|;:,.<>?';
    let out = '';
    const cryptoObj = window.crypto || window.msCrypto;
    if (cryptoObj && cryptoObj.getRandomValues) {
        const buf = new Uint32Array(length);
        cryptoObj.getRandomValues(buf);
        for (let i = 0; i < length; i++) {
            out += chars[buf[i] % chars.length];
        }
    } else {
        for (let i = 0; i < length; i++) out += chars[Math.floor(Math.random() * chars.length)];
    }
    return out;
}

function generateModalPassword() {
    const pwd = generatePassword(12);
    const el = document.getElementById('modal-new-password');
    if (el) el.value = pwd;
}

function copyModalPassword() {
    const el = document.getElementById('modal-new-password');
    if (!el) return;
    const text = el.value || '';
    navigator.clipboard?.writeText(text).then(() => {
        const btn = event?.target?.closest('button') || null;
        if (btn) {
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied';
            setTimeout(() => { btn.innerHTML = original; }, 1200);
        }
    }).catch(() => {
        alert('Copy failed — your browser may not allow clipboard operations.');
    });
}

// Admin auth flow
function openAdminAuthModal(action, target_type, target_id, details) {
    document.getElementById('admin-auth-action').value = action;
    document.getElementById('admin-auth-target-type').value = target_type;
    document.getElementById('admin-auth-target-id').value = target_id;
    document.getElementById('admin-auth-details').value = details;
    document.getElementById('admin-auth-feedback').style.display = 'none';
    document.getElementById('admin-auth-password').value = '';
    var modal = new bootstrap.Modal(document.getElementById('adminAuthModal'));
    modal.show();
}

function submitAdminAuth() {
    const password = document.getElementById('admin-auth-password').value;
    const action = document.getElementById('admin-auth-action').value;
    const target_type = document.getElementById('admin-auth-target-type').value;
    const target_id = document.getElementById('admin-auth-target-id').value;
    const details = document.getElementById('admin-auth-details').value;
    const feedback = document.getElementById('admin-auth-feedback');

    if (!password) { feedback.innerText = 'Password is required.'; feedback.style.display = 'block'; return; }

    fetch('/admin/verify_action', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password, action: action, target_type: target_type, target_id: target_id, details: details })
    }).then(r => r.json()).then(resp => {
        if (resp.status === 'ok') {
            // authorized — perform the requested UI action
            if (action === 'reveal_password') {
                // reveal the row's password (skip auth to avoid loop)
                const btn = document.querySelector('[data-student-id="' + target_id + '"][data-action="show"]');
                if (btn) toggleRowPassword(btn, true);
            } else if (action === 'copy_password') {
                // copy the password text
                const copyBtn = document.querySelector('[data-student-id="' + target_id + '"][data-action="copy"]');
                if (copyBtn) {
                    // perform copy action directly
                    const studentId = copyBtn.getAttribute('data-student-id');
                    const pwdEl = document.getElementById('pwd-' + studentId);
                    const text = pwdEl ? (pwdEl.textContent || pwdEl.innerText || '') : '';
                    if (text) navigator.clipboard?.writeText(text).catch(()=>{});
                    try { sendAdminLog('copy_password', 'student', target_id, 'Copied password hash from admin UI (authorized)'); } catch(e){}
                }
                // If target was modal-generated password, also handle that
                if (document.getElementById('modal-new-password') && document.getElementById('admin-auth-target-id').value === '') {
                    const modalPwd = document.getElementById('modal-new-password');
                    if (modalPwd) navigator.clipboard?.writeText(modalPwd.value).catch(()=>{});
                    try { sendAdminLog('copy_password', 'student', document.getElementById('modal-student-id')?.value || null, 'Copied generated password from reset modal (authorized)'); } catch(e){}
                }

            }
            var modalEl = document.getElementById('adminAuthModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        } else {
            feedback.innerText = resp.message || 'Authorization failed';
            feedback.style.display = 'block';
        }
    }).catch(err => {
        feedback.innerText = 'Authorization failed (network)'; feedback.style.display = 'block';
    });
}

// Auto-show the plaintext password modal if server set a last_reset
document.addEventListener('DOMContentLoaded', function() {
    try {
        const lastResetEl = document.getElementById('last-reset-data');
        const lastReset = lastResetEl ? JSON.parse(lastResetEl.textContent || 'null') : null;
        if (lastReset) {
            var nameDisplay = document.getElementById('show-modal-student');
            var pwdInput = document.getElementById('show-modal-password');
            var copyBtn = document.getElementById('show-modal-copy');
            if (nameDisplay) nameDisplay.textContent = lastReset.student_name ? ('Student: ' + lastReset.student_name) : ('Student ID: ' + lastReset.student_id);
            if (pwdInput) pwdInput.value = lastReset.password || '';
            if (copyBtn) copyBtn.addEventListener('click', function() {
                const text = pwdInput.value || '';
                navigator.clipboard?.writeText(text).then(()=>{
                    const original = copyBtn.innerHTML; copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied'; setTimeout(()=>{ copyBtn.innerHTML = original }, 1200);
                }).catch(()=>{ alert('Copy failed'); });
            });
            var m = new bootstrap.Modal(document.getElementById('showPasswordModal'));
            m.show();
        }
    } catch(e) {
        // ignore client-side rendering errors
    }
    // Attach event listeners to buttons (avoid inline onclicks and globals)
    try {
        // show/hide password buttons
        document.querySelectorAll('button[data-action="show"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                toggleRowPassword(btn);
            });
        });

        // copy password buttons
        document.querySelectorAll('button[data-action="copy"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                copyPassword(btn);
            });
        });

        // reset buttons
        document.querySelectorAll('button[data-action="reset"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                openResetModalFromButton(btn);
            });
        });

        // toggle passwords master button
        const toggleBtn = document.getElementById('togglePasswordBtn');
        if (toggleBtn) toggleBtn.addEventListener('click', function(e) { togglePasswordVisibility(); });

        // modal generate / copy buttons
        document.querySelectorAll('button[data-modal-action]').forEach(btn => {
            const act = btn.getAttribute('data-modal-action');
            if (act === 'generate') btn.addEventListener('click', generateModalPassword);
            if (act === 'copy') btn.addEventListener('click', copyModalPassword);
        });

        // admin auth confirm button
        const authConfirmBtn = document.getElementById('admin-auth-confirm-btn');
        if (authConfirmBtn) authConfirmBtn.addEventListener('click', submitAdminAuth);

        // attach confirm dialog for .confirm-submit elements
        document.querySelectorAll('.confirm-submit').forEach(el => {
            el.addEventListener('click', function(e) {
                const msg = el.getAttribute('data-confirm') || 'Are you sure?';
                if (!confirm(msg)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                return true;
            });
        });
    } catch(err) {
        // if attaching listeners fails, fall back to exposing globals (already set earlier)
        try { window.openResetModalFromButton = openResetModalFromButton; } catch(e) {}
    }
    // Ensure password hashes are hidden by default on load
    try {
        passwordsVisible = false;
        document.querySelectorAll('.password-display').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.password-hidden').forEach(el => el.style.display = 'inline');
        const toggleBtn = document.getElementById('togglePasswordBtn');
        const toggleText = document.getElementById('toggleText');
        if (toggleBtn) { toggleBtn.classList.remove('btn-warning'); toggleBtn.classList.add('btn-light'); }
        if (toggleText) toggleText.innerHTML = '<i class="fas fa-eye-slash"></i> Show Passwords';
    } catch(e) {
        // ignore
    }
});
// Expose handlers to global scope for inline onclick attributes
try {
    window.openResetModalFromButton = openResetModalFromButton;
    window.openResetModal = openResetModal;
    window.toggleRowPassword = toggleRowPassword;
    window.copyPassword = copyPassword;
} catch(e) {}
</script>
{% endblock %}
